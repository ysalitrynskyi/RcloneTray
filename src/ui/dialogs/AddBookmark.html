<!doctype html>
<html>
<head>
  <title>New Bookmark</title>
  <script defer>
    $main.loadStyles()
  </script>
  <style>
    body {
      padding: 0;
    }
    
    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color, #e0e0e0);
      background: var(--bg-primary, #fafafa);
    }
    
    .header h1 {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text-primary, #1a1a1a);
    }
    
    .header select {
      width: 100%;
    }
    
    .form-body {
      padding: 16px 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-primary, #1a1a1a);
    }
    
    .form-label small {
      font-weight: 400;
      color: var(--text-secondary, #666);
      margin-left: 4px;
    }
    
    #provider-settings-wrapper {
      display: none;
    }
    
    #bookmark-settings {
      margin-top: 16px;
    }
    
    .form-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-color, #e0e0e0);
      display: flex;
      justify-content: flex-end;
      background: var(--bg-primary, #fafafa);
    }
    
    @media (prefers-color-scheme: dark) {
      .header {
        background: var(--bg-primary, #1c1c1e);
        border-color: var(--border-color, #3a3a3c);
      }
      .form-footer {
        background: var(--bg-primary, #1c1c1e);
        border-color: var(--border-color, #3a3a3c);
      }
    }
  </style>
</head>
<body>
  <form id="the-form">
    <div class="header">
      <h1>Create New Bookmark</h1>
      <select name="type" id="providers-list">
        <option value="">— Select Provider —</option>
      </select>
    </div>

    <div id="provider-settings-wrapper">
      <div class="form-body">
        <div class="form-group">
          <label class="form-label">
            Name <small>(required)</small>
          </label>
          <input type="text" name="name" id="bookmark-name" maxlength="20" placeholder="My Cloud Storage" required>
        </div>
        
        <div id="bookmark-settings"></div>
      </div>

      <div class="form-footer">
        <button type="submit">Create Bookmark</button>
      </div>
    </div>
  </form>

  <script>
    (async function() {
      const theForm = document.getElementById('the-form');
      const providerSettingsWrapper = document.getElementById('provider-settings-wrapper');
      const bookmarkSettingsWrapper = document.getElementById('bookmark-settings');
      const providersListSelect = document.getElementById('providers-list');

      try {
        // Fetch providers
        const providers = await $main.rclone.providers();
        
        // Populate select options
        for (const providerName in providers) {
          const option = document.createElement('option');
          option.value = providerName;
          option.textContent = providers[providerName].Description;
          option.providerObject = providers[providerName];
          providersListSelect.appendChild(option);
        }

        // Handle provider selection
        providersListSelect.addEventListener('change', function() {
          const selectedOption = this.selectedOptions[0];
          
          if (selectedOption && selectedOption.providerObject) {
            const provider = selectedOption.providerObject;
            document.title = `New ${provider.Name} Bookmark`;
            window.api.renderBookmarkSettings(bookmarkSettingsWrapper, this.value);
            providerSettingsWrapper.style.display = 'block';
          } else {
            document.title = 'New Bookmark';
            providerSettingsWrapper.style.display = 'none';
            bookmarkSettingsWrapper.innerHTML = '';
          }
          
          window.electronAPI.resizeToContent();
        });

        // Trigger initial resize
        window.electronAPI.resizeToContent();

        // Handle form submission
        theForm.addEventListener('submit', async function(event) {
          event.preventDefault();

          const data = window.electronAPI.getTheFormData(this);

          try {
            await $main.rclone.addBookmark(data.type, data.name, data.options || {});
            window.close();
          } catch (error) {
            window.electronAPI.errorBox(error.message || String(error));
          }
        });
        
      } catch (error) {
        console.error('Failed to load providers:', error);
        window.electronAPI.errorBox('Failed to load providers: ' + (error.message || error));
      }
    })();
  </script>
</body>
</html>
