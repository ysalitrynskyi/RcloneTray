<!doctype html>
<html>

  <head>
    <title>RcloneTray Preferences</title>
    <script defer>
      $main.loadStyles()

      document.addEventListener('DOMContentLoaded', async function () {
        // Fetch all settings asynchronously
        const [
          isAutostart,
          trayMenuShowType,
          rcloneConfigFile,
          rcloneUseBundled,
          rcloneCacheFiles,
          rcloneCacheDirectories,
          customArgs,
          rcloneNcduEnable,
          rcloneSyncEnable,
          rcloneSyncAutouploadDelay,
          rcloneServingHttpEnable,
          rcloneServingFtpEnable,
          rcloneServingResticEnable,
          rcloneServingWebdavEnable,
          rcloneServingUsername,
          rcloneServingPassword
        ] = await Promise.all([
          $main.isAutostart(),
          $main.getSetting('tray_menu_show_type'),
          $main.rclone.getConfigFile(),
          $main.getSetting('rclone_use_bundled'),
          $main.getSetting('rclone_cache_files'),
          $main.getSetting('rclone_cache_directories'),
          $main.getSetting('custom_args'),
          $main.getSetting('rclone_ncdu_enable'),
          $main.getSetting('rclone_sync_enable'),
          $main.getSetting('rclone_sync_autoupload_delay'),
          $main.getSetting('rclone_serving_http_enable'),
          $main.getSetting('rclone_serving_ftp_enable'),
          $main.getSetting('rclone_serving_restic_enable'),
          $main.getSetting('rclone_serving_webdav_enable'),
          $main.getSetting('rclone_serving_username'),
          $main.getSetting('rclone_serving_password')
        ])

        let tabs = window.htmlElements.createTabsElement()
        document.getElementById('preferences').appendChild(tabs)

        tabs.addTab('General', window.htmlElements.createOptionsFields([
          {
            $Label: 'Auto launch',
            $Type: 'boolean',
            Name: 'auto_start',
            Help: 'Automatically launch the app during user login',
            Provider: '',
            Default: false,
            Value: isAutostart,
            ShortOpt: '',
            Hide: 0,
            Required: false,
            IsPassword: false,
            NoPrefix: false,
            Advanced: false
          },
          {
            $Label: 'Show bookmarks type',
            $Type: 'boolean',
            Name: 'tray_menu_show_type',
            Help: '',
            Provider: '',
            Default: true,
            Value: trayMenuShowType,
            ShortOpt: '',
            Hide: 0,
            Required: false,
            IsPassword: false,
            NoPrefix: false,
            Advanced: false
          }
        ]))

        tabs.addTab('Rclone', window.htmlElements.createOptionsFields([
          {
            Name: 'rclone_config',
            $Label: 'Config',
            $Type: 'file',
            $RequireRestart: true,
            Help: 'Changing this option require restart.',
            Provider: '',
            Default: rcloneConfigFile,
            Value: '',
            ShortOpt: '',
            Hide: 0,
            Required: false,
            IsPassword: false,
            NoPrefix: false,
            Advanced: false
          },
          {
            Name: 'rclone_use_bundled',
            $Label: 'Use bundled Rclone',
            $Type: 'boolean',
            $RequireRestart: true,
            Help: 'Use the Rclone binary that is bundled with the app, otherwise installed system wide version will be used (if not found, then you will receive and error).',
            Provider: '',
            Default: true,
            Value: rcloneUseBundled,
            ShortOpt: '',
            Hide: 0,
            Required: false,
            IsPassword: false,
            NoPrefix: false,
            Advanced: false
          },
          {
            Name: 'rclone_cache_files',
            $Label: 'File cache time',
            $Type: 'numeric',
            Help: 'In seconds',
            Value: rcloneCacheFiles
          },
          {
            Name: 'rclone_cache_directories',
            $Label: 'Directory cache time',
            $Type: 'numeric',
            Help: 'In seconds',
            Value: rcloneCacheDirectories
          },
          {
            Name: 'custom_args',
            $Label: 'Custom Rclone setting args.',
            $Type: 'text',
            Help: 'Space or new-line separated rclone command arguments to be appended to all commands.\nCheck more at https://rclone.org/docs/',
            Value: customArgs,
            ShortOpt: '',
            Hide: 0,
            Required: false,
            IsPassword: false,
            NoPrefix: false,
            Advanced: false
          }
        ]))

        tabs.addTab('NCDU', window.htmlElements.createOptionsFields([
          {
            $Label: 'Enable',
            $Type: 'boolean',
            Name: 'rclone_ncdu_enable',
            Value: rcloneNcduEnable
          }
        ]))

        tabs.addTab('Upload/Download', window.htmlElements.createOptionsFields([
          {
            $Label: 'Enable',
            $Type: 'boolean',
            Name: 'rclone_sync_enable',
            Value: rcloneSyncEnable
          },
          {
            $Label: 'Automatic Upload Delay',
            $Type: 'select',
            Name: 'rclone_sync_autoupload_delay',
            Examples: [
              {
                Label: '1s',
                Value: 1
              },
              {
                Label: '3s',
                Value: 3
              },
              {
                Label: '5s',
                Value: 5
              },
              {
                Label: '7s',
                Value: 7
              },
              {
                Label: '10s',
                Value: 10
              },
              {
                Label: '15s',
                Value: 15
              }
            ],
            Value: rcloneSyncAutouploadDelay,
            $RequireRestart: true,
            Help: 'Need restart to take effect.'
          }
        ]))

        tabs.addTab('Serving', window.htmlElements.createOptionsFields([
          {
            $Label: 'Enable HTTP',
            $Type: 'boolean',
            Name: 'rclone_serving_http_enable',
            Value: rcloneServingHttpEnable
          },
          {
            $Label: 'Enable FTP',
            $Type: 'boolean',
            Name: 'rclone_serving_ftp_enable',
            Value: rcloneServingFtpEnable
          },
          {
            $Label: 'Enable Restic',
            $Type: 'boolean',
            Name: 'rclone_serving_restic_enable',
            Value: rcloneServingResticEnable
          },
          {
            $Label: 'Enable WebDAV',
            $Type: 'boolean',
            Name: 'rclone_serving_webdav_enable',
            Value: rcloneServingWebdavEnable
          },
          {
            $Label: 'Default username',
            $Type: 'string',
            Name: 'rclone_serving_username',
            Value: rcloneServingUsername
          },
          {
            $Label: 'Default password',
            $Type: 'password',
            Name: 'rclone_serving_password',
            Value: rcloneServingPassword
          }
        ]))

        window.electronAPI.resizeToContent()

        let theForm = document.getElementById('the-form')
        theForm.addEventListener('submit', async function (event) {
          event.preventDefault()
          let data = window.electronAPI.getTheFormData(this)

          let oldAutoStart = await $main.isAutostart()
          if (oldAutoStart !== !!(data.auto_start || false)) {
            $main.setAutostart(data.auto_start || false)
          }
          delete data['auto_start']

          await $main.settingsMerge(data)
          $main.refreshTray()
          
          if (window.requireRestart) {
            window.htmlElements.checkForRequiredRestart()
          } else {
            window.close()
          }
        })

      });
    </script>
  </head>

  <body>
    <form id="the-form">
      <div id="preferences"></div>
      <div class="row right buttons">
        <button type="submit">
          Save
        </button>
      </div>
    </form>
  </body>

</html>
