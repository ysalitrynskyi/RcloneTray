<!doctype html>
<html>
<head>
  <title>Edit Bookmark</title>
  <script defer>
    $main.loadStyles()
  </script>
  <style>
    body {
      padding: 0;
    }
    
    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color, #e0e0e0);
      background: var(--bg-primary, #fafafa);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-icon {
      width: 32px;
      height: 32px;
      background: var(--accent, #007AFF);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
    }
    
    .header-text h1 {
      font-size: 15px;
      font-weight: 600;
      margin: 0;
      color: var(--text-primary, #1a1a1a);
    }
    
    .header-text .type {
      font-size: 12px;
      color: var(--text-secondary, #666);
      margin-top: 2px;
    }
    
    .form-body {
      padding: 0;
    }
    
    #bookmark-settings {
      min-height: 200px;
    }
    
    .form-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-color, #e0e0e0);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-primary, #fafafa);
    }
    
    .btn-danger {
      background: transparent;
      color: #ff3b30;
      border: 1px solid #ff3b30;
    }
    
    .btn-danger:hover {
      background: #ff3b30;
      color: white;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary, #666);
    }
    
    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color, #e0e0e0);
      border-top-color: var(--accent, #007AFF);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (prefers-color-scheme: dark) {
      .header {
        background: var(--bg-primary, #1c1c1e);
        border-color: var(--border-color, #3a3a3c);
      }
      .form-footer {
        background: var(--bg-primary, #1c1c1e);
        border-color: var(--border-color, #3a3a3c);
      }
      .btn-danger {
        border-color: #ff453a;
        color: #ff453a;
      }
      .btn-danger:hover {
        background: #ff453a;
      }
    }
  </style>
</head>
<body>
  <form id="the-form">
    <div class="header">
      <div class="header-icon" id="bookmark-icon"></div>
      <div class="header-text">
        <h1 id="bookmark-name">Loading...</h1>
        <div class="type" id="bookmark-type"></div>
      </div>
    </div>

    <div class="form-body">
      <div id="bookmark-settings">
        <div class="loading">Loading settings</div>
      </div>
    </div>

    <div class="form-footer">
      <button type="button" class="btn-danger" id="delete-btn">Delete</button>
      <button type="submit">Save Changes</button>
    </div>
  </form>

  <script>
    (async function() {
      const theForm = document.getElementById('the-form');
      const bookmarkSettingsWrapper = document.getElementById('bookmark-settings');
      const deleteBtn = document.getElementById('delete-btn');

      try {
        // Get bookmark props from main process
        const props = await $main.getProps();
        
        if (!props || !props.$name) {
          throw new Error('Invalid bookmark data');
        }

        // Update header
        document.getElementById('bookmark-name').textContent = props.$name;
        document.getElementById('bookmark-type').textContent = props.type || 'Unknown';
        document.getElementById('bookmark-icon').textContent = (props.$name || 'B')[0];
        document.title = `Edit: ${props.$name}`;

        // Render bookmark settings
        window.api.renderBookmarkSettings(bookmarkSettingsWrapper, props.type, { options: props });

        // Handle form submission
        theForm.addEventListener('submit', async function(event) {
          event.preventDefault();

          const data = window.electronAPI.getTheFormData(this);

          try {
            await $main.rclone.updateBookmark(props.$name, data.options || {});
            window.close();
          } catch (error) {
            window.electronAPI.errorBox(error.message || String(error));
          }
        });

        // Handle delete
        deleteBtn.addEventListener('click', async function() {
          const confirmed = await window.electronAPI.confirm(
            `Are you sure you want to delete "${props.$name}"?\n\nThis action cannot be undone.`
          );
          
          if (confirmed) {
            try {
              await $main.rclone.delBookmark(props.$name);
              window.close();
            } catch (error) {
              window.electronAPI.errorBox(error.message || String(error));
            }
          }
        });

      } catch (error) {
        console.error('Failed to load bookmark:', error);
        bookmarkSettingsWrapper.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #ff3b30;">
            Failed to load bookmark: ${error.message || error}
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
